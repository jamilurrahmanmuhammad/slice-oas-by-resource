# ADR-004: Deterministic 7-Phase Validation Checkpoint

**Status**: Accepted

**Date**: 2025-12-17

**Context**

The slice-oas-by-resource tool must guarantee 100% output validity. Every generated OAS file must:

- Be immediately usable by downstream tools (validators, code generators, documentation generators)
- Pass OpenAPI specification compliance checks
- Have all $ref entries resolve successfully
- Match the source endpoint exactly (no data loss or corruption)
- Conform to the requested output version (3.0.x or 3.1.x)

Success criteria mandate:
- **SC-003**: 100% of generated output files pass OpenAPI specification validation
- **SC-004**: 100% of generated output files have all $ref entries resolved successfully
- **SC-010**: All sliced files are immediately usable by downstream OpenAPI tools without modification

The validation strategy must:
- Be deterministic (same input â†’ same validation result)
- Provide clear error messages for failures
- Fail fast (reject invalid outputs immediately)
- Support both OAS 3.0.x and 3.1.x
- Handle edge cases (circular refs, empty components, version-specific features)

**Decision**

We implement a **Deterministic 7-Phase Validation Checkpoint** pipeline. Each phase must pass before proceeding to the next. Failure at any phase immediately rejects the output file.

### Validation Phases (Constitutional Requirement)

#### Phase 1: File Structure Validation
- **Check**: Valid JSON/YAML syntax, root keys present
- **Validation**:
  - File can be parsed without syntax errors
  - Root object has `openapi`, `info`, `paths` keys
  - `openapi` field matches regex `^3\.(0|1)\.\d+$`
- **Failure**: File structure error (malformed output)
- **User Message**: "The output file couldn't be created due to a formatting error. This is an internal error. Please report this with your input file."

#### Phase 2: Operation Integrity Validation
- **Check**: Single path, single method, correct operation definition
- **Validation**:
  - `paths` section contains exactly one path
  - Path contains exactly one HTTP method
  - Operation has required fields: `responses` (minimum)
  - Method is valid HTTP verb (GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS, TRACE)
- **Failure**: Operation integrity error
- **User Message**: "The extracted endpoint has an invalid structure. This is an internal error. Please report this with your input file."

#### Phase 3: Response Integrity Validation
- **Check**: Response codes match, headers resolve, schemas present
- **Validation**:
  - All response codes in output match source operation
  - Response headers (if present) are valid and resolve
  - Response content schemas (if present) are valid
  - No phantom responses added or removed
- **Failure**: Response integrity error
- **User Message**: "The extracted endpoint's responses don't match the original specification. This is an internal error. Please report this with your input file."

#### Phase 4: Reference Resolution Validation
- **Check**: ALL $ref entries resolve to existing components
- **Validation**:
  - Every `$ref` in operation points to valid component
  - All referenced components exist in `components` section
  - No dangling references (refs to non-existent components)
  - External refs (http://, ../) are absent (not supported)
- **Failure**: Unresolved reference error
- **User Message**: "The extracted endpoint has missing components. The source file may be incomplete. Please verify all references in the original file resolve correctly."

#### Phase 5: Component Completeness Validation
- **Check**: No orphaned refs, required components non-empty
- **Validation**:
  - All components in `components` section are referenced by operation
  - No orphaned components (included but not referenced)
  - Required components (schemas, parameters, headers) are non-empty
  - Components follow OAS schema for their type
- **Failure**: Component completeness error
- **User Message**: "The extracted endpoint is missing required components or has extra unused components. This is an internal error. Please report this with your input file."

#### Phase 6: Payload Equivalence Validation
- **Check**: Operation matches parent spec exactly
- **Validation**:
  - Operation definition in output matches source operation byte-for-byte (ignoring $refs)
  - Parameters are identical
  - Request body is identical
  - Responses are identical
  - Security requirements are identical
  - Tags, summary, description, operationId preserved
- **Failure**: Payload equivalence error
- **User Message**: "The extracted endpoint doesn't match the original specification. This is an internal error. Please report this with your input file."

#### Phase 7: Version Validation
- **Check**: OAS version matches requested, schema syntax correct
- **Validation**:
  - `openapi` field matches requested output version family (3.0.x or 3.1.x)
  - If 3.0.x: no `webhooks`, no `pathItems` in components, no JSON Schema 2020-12 keywords
  - If 3.1.x: nullable converted to type arrays, JSON Schema features allowed
  - Version-specific validation using openapi-spec-validator
- **Failure**: Version validation error
- **User Message**: "The output file doesn't conform to the selected OpenAPI version. This may be due to version conversion issues. Try using the same version as the input file."

### Pipeline Execution

```python
class ValidationPipeline:
    def validate(self, output_file: Path, source_operation: dict, requested_version: str) -> List[ValidationResult]:
        phases = [
            self.phase_1_file_structure,
            self.phase_2_operation_integrity,
            self.phase_3_response_integrity,
            self.phase_4_reference_resolution,
            self.phase_5_component_completeness,
            self.phase_6_payload_equivalence,
            self.phase_7_version_validation,
        ]

        results = []
        for i, phase_func in enumerate(phases, start=1):
            result = phase_func(output_file, source_operation, requested_version)
            results.append(result)

            if not result.passed:
                # Fail fast: stop pipeline on first failure
                break

        return results
```

**Consequences**

### Positive

- **Quality Guarantee**: 7 independent checks ensure no invalid files are ever produced
- **Fail Fast**: First failure stops pipeline, saving processing time
- **Clear Error Attribution**: Each phase has specific failure mode and user message
- **Deterministic**: Same input always produces same validation result (no flakiness)
- **Version Awareness**: Phase 7 catches version-specific issues (3.0.x vs 3.1.x)
- **Constitutional Compliance**: Satisfies Principle IV (Deterministic Validation)
- **Debugging Support**: Phase results can be logged for troubleshooting
- **Immediate Usability**: Passing all 7 phases guarantees downstream tool compatibility

### Negative

- **Performance Overhead**: 7 passes over each file adds processing time
  - Mitigation: Early exit on first failure; phases are fast (<100ms each)
  - Acceptable: Performance target (<5s) is still met
- **Implementation Complexity**: Each phase requires separate validation logic
  - Mitigation: Clear phase interfaces; unit tests per phase; reusable validation utilities
- **Rigid Pipeline**: Cannot skip phases or reorder them
  - Acceptable: Phase ordering is constitutional requirement; rigidity ensures consistency

### Risks

- **False Negatives**: Validation may miss edge cases
  - Mitigation: Comprehensive test suite with fixtures covering edge cases; use openapi-spec-validator for final check
- **Version-Specific Bugs**: Phase 7 may have gaps in version-specific validation
  - Mitigation: Research phase documented version conversion rules; extensive 3.0.x and 3.1.x test fixtures
- **Performance Degradation**: Large files (10MB+) may slow down validation
  - Mitigation: Performance testing with large fixtures; optimize hot paths if needed

**Alternatives Considered**

### Alternative 1: Single-Pass Validation
- **Description**: Validate all aspects in one pass through the file
- **Pros**: Faster (one traversal), simpler code structure
- **Cons**:
  - Error attribution unclear (which check failed?)
  - Harder to maintain (all checks in one function)
  - Violates constitutional requirement for 7 explicit phases
- **Rejected**: Constitution explicitly requires 7 phases with clear boundaries

### Alternative 2: Lazy Validation (Validate Only on Failure)
- **Description**: Only validate when downstream tools report errors
- **Pros**: Minimal overhead, fast processing
- **Cons**:
  - Violates quality guarantee (invalid files may be produced)
  - Poor user experience (errors discovered late)
  - Fails constitutional requirement for deterministic validation
- **Rejected**: Unacceptable risk of producing invalid outputs

### Alternative 3: Multi-Level Tolerances (Warn vs Fail)
- **Description**: Some checks are warnings (logged but don't fail), others are hard failures
- **Pros**: Flexibility for non-critical issues
- **Cons**:
  - Non-deterministic (what's a warning vs failure?)
  - Violates 100% validity requirement
  - Confusing user experience (file passes but has warnings?)
- **Rejected**: Constitution requires 100% pass rate; warnings introduce ambiguity

### Alternative 4: External Validator Only (openapi-spec-validator)
- **Description**: Skip custom validation, rely entirely on openapi-spec-validator
- **Pros**: Less code to maintain, battle-tested library
- **Cons**:
  - Misses tool-specific checks (payload equivalence, component completeness)
  - Less granular error messages
  - Cannot enforce constitutional phases
  - Doesn't check for commonly-missed response headers
- **Rejected**: External validator is necessary but not sufficient; use as Phase 7 final check

**References**

- [Specification](/home/jamil/repos/slice-oas-by-resource/specs/001-slice-oas-by-resource/spec.md) - FR-026 to FR-030 (validation requirements)
- [Implementation Plan](/home/jamil/repos/slice-oas-by-resource/specs/001-slice-oas-by-resource/plan.md) - Constitution Check: Principle IV
- [Data Model: ValidationResult](/home/jamil/repos/slice-oas-by-resource/specs/001-slice-oas-by-resource/data-model.md) - Lines 207-249
- Success Criteria: SC-003, SC-004, SC-010
- Constitution: Principle IV (Deterministic Validation)
