# ADR-006: Real-Time CSV Append-Mode Index with Deduplication

**Status**: Accepted

**Date**: 2025-12-17

**Context**

The slice-oas-by-resource tool must track all extracted endpoints for API governance and reporting. Requirements include:

- **FR-022**: System MUST generate a CSV index file during batch extraction operations
- **FR-023**: CSV index MUST include: path, method, OpenAPI version, source file, output file, timestamp, validation status
- **FR-024**: System MUST update the CSV index in real-time as each endpoint is processed
- **FR-025**: CSV index MUST be compatible with standard spreadsheet software (RFC 4180 compliance)
- **SC-008**: CSV index accurately tracks all sliced resources with correct metadata in 100% of batch operations

Constitutional requirement (Principle V: CSV Indexing):
> "Real-time resource tracking with exact column order including output_oas_version"

The CSV tracking strategy must:
- Update in real-time (not batch at end)
- Handle interruptions gracefully (partial completion)
- Prevent duplicates (same path+method processed twice)
- Support resume operations (re-run batch without duplication)
- Be platform-independent (work on Linux, macOS, Windows)
- Require no database or external dependencies

**Decision**

We implement **Real-Time CSV Append-Mode Index with Pre-Write Deduplication**:

### CSV Schema (Constitutional Requirement - Exact Order)

```csv
path,method,summary,description,operationId,tags,filename,file_size_kb,schema_count,parameter_count,response_codes,security_required,deprecated,created_at,output_oas_version
/users/{id},GET,Get user by ID,Retrieve a single user,getUserById,"users,accounts",users-id-get.yaml,12.3,5,1,"200,404",true,false,2025-12-17T10:30:00Z,3.1.0
```

**Column Definitions**:
1. `path`: API path template (e.g., "/users/{id}")
2. `method`: HTTP method (uppercase: GET, POST, etc.)
3. `summary`: Short description from operation.summary
4. `description`: Full description from operation.description
5. `operationId`: Unique operation identifier (if present)
6. `tags`: Comma-separated tags (if present)
7. `filename`: Output file name (e.g., "users-id-get.yaml")
8. `file_size_kb`: Output file size in kilobytes (float)
9. `schema_count`: Number of schemas included in output
10. `parameter_count`: Number of parameters in operation
11. `response_codes`: Comma-separated response codes (e.g., "200,404")
12. `security_required`: Boolean (true/false)
13. `deprecated`: Boolean deprecation status
14. `created_at`: ISO 8601 timestamp
15. `output_oas_version`: Output OAS version (e.g., "3.1.0")

### Append Strategy with Deduplication

```python
def append_to_csv_index(entry: CSVIndexEntry, csv_path: Path) -> None:
    """Append entry to CSV index with duplicate detection."""
    # Phase 1: Check for existing entry (duplicate detection)
    if csv_path.exists():
        existing_entries = read_csv(csv_path)
        for existing in existing_entries:
            if existing['path'] == entry.path and existing['method'] == entry.method:
                # Update existing entry instead of duplicating
                update_csv_entry(csv_path, entry)
                return

    # Phase 2: Append new entry
    with csv_path.open('a', newline='', encoding='utf-8') as f:
        writer = csv.DictWriter(f, fieldnames=CSV_COLUMNS)
        if csv_path.stat().st_size == 0:
            writer.writeheader()  # Write header if file is new
        writer.writerow(entry.to_dict())
```

### Key Features

1. **Real-Time Updates**: CSV written immediately after each successful extraction
2. **Duplicate Detection**: Before appending, scan existing CSV for path+method combination
3. **Atomic Appends**: Each write is a single operation (no partial rows)
4. **RFC 4180 Compliance**: Proper quoting and escaping for spreadsheet compatibility
5. **No File Locking**: Single-threaded CLI doesn't need concurrency control
6. **Resume Safety**: Interrupted batch can be re-run; duplicates detected and skipped
7. **Platform Independent**: Uses Python's csv module (works on all platforms)

### Deduplication Logic

**Primary Key**: `(path, method)` combination uniquely identifies an endpoint

**Collision Behavior**:
- If path+method exists: Update existing entry with new data (timestamp, file_size_kb, etc.)
- If path+method is new: Append new row

**Rationale**: Re-running batch extraction should update existing entries, not create duplicates

**Consequences**

### Positive

- **Constitutional Compliance**: Satisfies Principle V (Real-Time CSV Indexing)
- **Interruption Resilience**: Partial completion is tracked; resume is safe
- **Governance Support**: Accurate tracking enables API cataloging and governance workflows
- **No Database Required**: File-based tracking is simple and portable
- **Spreadsheet Compatible**: CSV can be opened directly in Excel, Google Sheets, LibreOffice
- **Timestamp Tracking**: `created_at` provides audit trail
- **Version Tracking**: `output_oas_version` enables version governance
- **Performance**: O(n) duplicate check per append (negligible for <1000 endpoints)

### Negative

- **Linear Scan for Duplicates**: O(n) check per append (read entire CSV)
  - Mitigation: For typical batch sizes (<1000 endpoints), scan is fast (<100ms total)
  - Acceptable: Performance target (<3 min for 100 endpoints) is easily met
- **CSV Size Growth**: Large batch operations create large CSV files
  - Mitigation: CSV is human-readable and compresses well; can be archived/rotated
- **No Concurrent Writes**: Single-threaded assumption; concurrent writes would corrupt CSV
  - Acceptable: CLI is single-threaded by design; no concurrency needed

### Risks

- **CSV Corruption**: Manual edits to CSV may break parsing
  - Mitigation: Validate CSV on read; skip malformed rows with warning
- **Disk Space**: Batch operations with 1000+ endpoints create large CSVs
  - Mitigation: Document expected CSV size; users responsible for disk space management
- **Update Logic Complexity**: Updating existing entry is more complex than append-only
  - Mitigation: Test coverage for update scenarios; clear update logic

**Alternatives Considered**

### Alternative 1: In-Memory Buffer with Final Write
- **Description**: Collect all entries in memory, write CSV once at end of batch
- **Pros**: Single atomic write, no duplicate checks needed, faster (no I/O per entry)
- **Cons**:
  - Violates constitutional requirement for real-time updates
  - No visibility into progress
  - Interruption loses all progress
- **Rejected**: Fails constitutional requirement (Principle V: Real-Time Updates)

### Alternative 2: Append-Only with Post-Processing Deduplication
- **Description**: Append all entries (including duplicates), deduplicate at end
- **Pros**: Simplest append logic, no pre-append checks
- **Cons**:
  - Temporary CSV has duplicates (confusing for users)
  - Requires post-processing step (adds complexity)
  - Users may see duplicates if interrupted
- **Rejected**: Poor user experience; duplicates violate governance use case

### Alternative 3: SQLite Database
- **Description**: Use SQLite for tracking instead of CSV
- **Pros**: ACID guarantees, efficient queries, natural deduplication via primary key
- **Cons**:
  - Adds external dependency (sqlite3 library)
  - Binary format (not human-readable)
  - Not spreadsheet-compatible (requires export)
  - Over-engineering for simple tracking use case
- **Rejected**: CSV meets requirements with simpler implementation; no database needed

### Alternative 4: JSON Index File
- **Description**: Use JSON instead of CSV for index
- **Pros**: Hierarchical structure, easier to parse programmatically, supports nested data
- **Cons**:
  - Not spreadsheet-compatible (violates FR-025)
  - Harder for non-technical users to review
  - No advantage over CSV for flat tabular data
- **Rejected**: CSV is more accessible and meets spreadsheet compatibility requirement

### Alternative 5: File Locking (fcntl/msvcrt)
- **Description**: Acquire exclusive lock before each append, release after write
- **Pros**: Prevents concurrent write corruption
- **Cons**:
  - Platform-specific (Unix vs Windows different APIs)
  - Unnecessary complexity for single-threaded CLI
  - Adds failure modes (lock acquisition failures)
- **Rejected**: Over-engineering; single-threaded CLI has no concurrency

**References**

- [Specification](/home/jamil/repos/slice-oas-by-resource/specs/001-slice-oas-by-resource/spec.md) - FR-022 to FR-025 (CSV requirements)
- [Implementation Plan](/home/jamil/repos/slice-oas-by-resource/specs/001-slice-oas-by-resource/plan.md) - Constitution Check: Principle V
- [Research: CSV Index Concurrency](/home/jamil/repos/slice-oas-by-resource/specs/001-slice-oas-by-resource/research.md#research-task-4-csv-index-concurrency)
- [Data Model: CSVIndexEntry](/home/jamil/repos/slice-oas-by-resource/specs/001-slice-oas-by-resource/data-model.md) - Lines 252-292
- Success Criteria: SC-008
- Constitution: Principle V (CSV Indexing - Real-Time Resource Tracking)
